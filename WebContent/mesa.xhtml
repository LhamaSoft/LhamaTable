<?php
	include("login.php");
			loginCheck();
	
	$sql = "SELECT mesaID
			FROM usuarios
			WHERE ID = '".$_SESSION['ID']."' ";
	$query = mysql_query($sql) or die (mysql_error());
	$result = mysql_fetch_assoc($query);
	$_SESSION['usuarioMesaID'] = $result['mesaID'];
	
	if(!isset($_SESSION['nomeMesa']) OR !isset($_SESSION['mesaID']) OR ($_SESSION['usuarioMesaID'] == 0))
	{
		header("location:perfil.xhtml");
	}
?>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"  
    xmlns:f="http://java.sun.com/jsf/core"  
    xmlns:h="http://java.sun.com/jsf/html">
  <head>
  
	<meta http-equiv="refresh" content="60">
	
  	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"/>

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    
    <!--<link href="CSS/signin.css" rel="stylesheet"/>-->
    <link href="CSS/text.css" rel="stylesheet"/>
    
  
	<link rel="shortcut icon" href="image/lhamaFav.ico"/>
    <title>Mesa</title>
    
    <link rel="stylesheet" type="text/css" href="CSS/mesa.css"></link>
    <link rel="stylesheet" type="text/css" href="CSS/button.css"></link>
    <link rel="stylesheet" type="text/css" href="CSS/textarea.css"></link>
    <link rel="stylesheet" type="text/css" href="js/jScrollPane/jScrollPane.css" />
	<!--<link rel="stylesheet" type="text/css" href="CSS/page.css" />-->
	<link rel="stylesheet" type="text/css" href="CSS/chat.css" />
	
	<script>
		function autoRefresh_div()
		{
			$("#mensagens").load('mesa.xhtml' + ' #mensagens');// a function which will load data from other file after x seconds
		}
 
		setInterval('autoRefresh_div()', 5000); // refresh div after 5 secs
		
		
		var height = 0;
		$('#mensagens').each(function(i, value){
		height += parseInt($(this).height());
		});

		height += '';

		$('#mensagens').animate({scrollTop: height});
    </script>
    
  </head>

  <body style="background-color:#211733">
  	<div class="container border2" > <!-- O CSS "container" ta influenciando aqui, deixando a parte de tras transparente igual na mainpage -->
		<div class="row">        	
			<div class="col-md-2 border2" id="lateral esq">
				<h4 class="heading"><?php echo $_SESSION['nomeMesa']; ?></h4>
				<p style="color:#ffffff">ID: <?php echo $_SESSION['mesaID']; ?></p>
				<p style="color:#ffffff">Mestre: <?php echo $_SESSION['mestreNome']; ?></p>
				<div class="dropdown">
					<button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">MENU
					<span class="caret"></span></button>
					<ul class="dropdown-menu">
						<li><button type="button" data-toggle="modal" data-target="#myEditar">Editar</button></li>
						<li><button type="button" data-toggle="modal" data-target="#myDeletar">Deletar</button></li>
					</ul>
				</div>
<!-- Modal -->
				<div id="myEditar" class="modal fade" role="dialog">
					<div class="modal-dialog">
						<!-- Modal content-->
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal">&times;</button>
								<h4 class="modal-title">Editar</h4>
							</div>
							<div class="modal-body">
								<form>
									<div id="edMesa">
										<form class="form-horizontal">
											<fieldset>
												<div class="form-group">
													<label class=" control-label" for="id">Nome:</label>  
													<input id="idMesa" name="idMesa" placeholder="" class="form-control input-md" required="" type="text"/>
												</div>
												<div class="form-group">
													<label class=" control-label" for="senha">Senha:</label>
													<input id="senha" name="senha" placeholder="" class="form-control input-md" required="" type="password"/>
												</div>
												<div class="form-group">
													<label class=" control-label" for="criar"></label>
													<button id="buscar" name="buscar" class="btn btn-default" type="submit">OK</button>
												</div>
											</fieldset>
										</form>
									</div>
								</form>
								<div class="modal-footer">
									<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
								</div>
							</div>

						</div>
					</div>
				</div>
				
				<div id="myDeletar" class="modal fade" role="dialog">
					<div class="modal-dialog">
						<!-- Modal content-->
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal">&times;</button>
								<h4 class="modal-title">Deletar</h4>
							</div>
							<div class="modal-body">
								<form>
									<div id="deMesa">
										<form class="form-horizontal">
											<fieldset>
												<div class="form-group">
													<label class=" control-label" for="senha">Senha:</label>
													<input id="senha" name="senha" placeholder="" class="form-control input-md" required="" type="password"/>
												</div>
												<div class="form-group">
													<label class=" control-label" for="criar"></label>
													<button id="buscar" name="buscar" class="btn btn-default" type="submit">Excluir</button>
												</div>
											</fieldset>
										</form>
									</div>
								</form>
								<div class="modal-footer">
									<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div id="menu">
					<form role="form" method="post" action="alteraMesa.php">
						<button class="btn" data-toggle="collapse" data-target="#edMesa" >Editar Mesa</button>

								<div id="edMesa" class="collapse heading">
									<form class="form-horizontal">
									<fieldset>
									<div class="form-group">
									  <label class=" control-label" for="alteraMesa">Nome:</label>  
									  <input id="idMesa" name="alteraMesa" placeholder="" class="form-control input-md" required="" type="text"/>
									  
									</div>
									<div class="form-group">
									  <label class=" control-label" for="novaSenha">Senha:</label>
									    <input id="senha" name="novaSenha" placeholder="" class="form-control input-md" required="" type="password"/>
									</div>
									<div class="form-group">
									  <label class=" control-label" for="alterarM"></label>
									    <input id="alterarM" name="alterarM" class="btn btn-default" value="alterarM" type="submit">
									</div>
									
									</fieldset>
									</form>
								</div>
		</form>
		
		<form role="form" method="post" action="removeMesa.php">
        <button class="btn" data-toggle="collapse" data-target="#deMesa" >Deletar Mesa</button>

								<div id="deMesa" class="collapse heading">
									<form class="form-horizontal">
									<fieldset>
									<div class="form-group">
									  <label class=" control-label" for="removeMesa">Senha:</label>
									    <input id="removeMesa" name="removeMesa" placeholder="" class="form-control input-md" required="" type="password"/>
									</div>
									<div class="form-group">
									  <label class=" control-label" for="removeM"></label>
									    <input id="removeM" name="removeM" class="btn btn-default" value="Alterar" type="submit" >
									</div>
									
									</fieldset>
									</form>
								</div>
								<form method="POST" action="saiMesa.php">
								<button id="sair" name="sair" class="btn btn-default" type="submit">Sair</button>
								</form> 
		</form>
				
   		</div>
   				<br/>
   				<br/>
			 	<h4 class="heading">Criar Fichas</h4>
			 	<br/>
				<form method="POST" action="criaFicha.php">
			 	<input type="text" id="ficha" class="form-control" placeholder="Nome da ficha" name="nomeFicha"/>
			 	<button class="btn btn-primary btn-block" type="submit">Criar</button>
				</form>
				
				</br>
				<form method="POST" action="removeFicha.php">
				<input type="text" id="ficha" class="form-control" placeholder="Nome da ficha" name="nomeFicha"/>
			 	<button class="btn btn-primary btn-block" type="submit">Deletar</button>
				</form>
				
				<h4 class="heading">Fichas na Mesa</h4>
				<?php
					$sql = "SELECT nome, caminhoFicha
							FROM ficha
							WHERE mesaID = '".$_SESSION['mesaID']."' ";
							$query = mysql_query($sql) or die (mysql_error());
							while($row = mysql_fetch_row($query))
							{
								$nome = $row[0];
								echo nl2br ("$nome \n");
							}
				?>
			 </div>	
		 
		 
				<div class="col-md-7" id="chat">
					<div id="mensagens">
						<?php 
							$sql = "SELECT mensagem, jogador, horario
							FROM chatMensagens
							WHERE mesaID = '".$_SESSION['mesaID']."'";
							$query = mysql_query($sql) or die(mysql_error()) ;
							while($row = mysql_fetch_row($query))
							{
								$sql2 = "SELECT nomeUsuario
									FROM usuarios
									WHERE ID = '".$row[1]."'";
								$query2 = mysql_query($sql2) or die(mysql_error()) ;
								$result = mysql_fetch_assoc($query2);
								$mensagem = $row[0];
								$timestamp = strtotime($row[2]);
								$horario = date('H:i', $timestamp);
								$jogador = $result['nomeUsuario'];
								echo "<p style='font-family:Fantasy;'>".$jogador.": ".$mensagem." ".$horario."</p>";						
							}
							?>
					</div>	
					<div id="caixa">
						<form method="POST" action="enviaMensagem.php">
						<textarea class="col-md-9" rows="1" cols="150" id="mensagem" name="mensagem"> </textarea>
						<button id="send" name="send" class="btn col-md-2" value="Enviar" type="submit" style="width:160px; height:40px">Enviar</button>
						</form>
					</div>	

				</div>

			<div class="col-md-3 border2" id="lateral dir">
					<h4 class="heading">Jogadores</h4>
						<?php 
							$sql = "SELECT nomeUsuario
							FROM usuarios
							WHERE mesaID = '".$_SESSION['mesaID']."'";
						$query = mysql_query($sql) or die(mysql_error()) ;
						while($row = mysql_fetch_row($query))
						{
							$nome = $row[0];
							echo nl2br ("$nome \n");
						}
						?>
 			</div>
		</div>	
		
			<div class="col-md-10">
				<ul id="dados">
					<form method="POST" action="enviaMensagem.php"
						<li id="map"><button type="button" data-toggle="modal" data-target="#myMap"><img src="images/Map_Icon.png" alt="" /></button></li>
						<li><button type="submit" name="d4"><img src="images/d4.png" alt="" /></button></li>
						<li><button type="submit" name="d6"><img src="images/d6.png" alt="" /></button></li>
						<<li><button type="submit" name="d8"><img src="images/d8.png" alt="" /></button></li>
						<li><button type="submit" name="d10"><img src="images/d10.png" alt="" /></button></li>
						<li><button type="submit" name="d12"><img src="images/d12.png" alt="" /></button></li>
						<li><button type="submit" name="d20"><img src="images/d20_icon.png" alt="" /></button></li>
						<li><button type="submit" name="d100"><img src="images/d_porcento.png" alt="" /></button></li>
					</form>
				</ul>
			</div>
		
		
		<div id="myMap" class="modal fade" role="dialog">
			<div class="modal-dialog">
			<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Mapa</h4>
					</div>
					<div class="modal-body">
						<img src="images/mapa.png" style = "width: 550px"></img>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>	
	</div>		 


   		
		
	</div>
  </body>
</html>
