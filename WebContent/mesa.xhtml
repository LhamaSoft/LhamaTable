<?php
	include("login.php");
			loginCheck();
	
	$sql = "SELECT mesaID
			FROM usuarios
			WHERE ID = '".$_SESSION['ID']."' ";
	$query = mysql_query($sql) or die (mysql_error());
	$result = mysql_fetch_assoc($query);
	$_SESSION['usuarioMesaID'] = $result['mesaID'];
	
	if(!isset($_SESSION['nomeMesa']) OR !isset($_SESSION['mesaID']) OR ($_SESSION['usuarioMesaID'] == 0))
	{
		header("location:perfil.xhtml");
	}
?>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"  
    xmlns:f="http://java.sun.com/jsf/core"  
    xmlns:h="http://java.sun.com/jsf/html">
  <head>
  
	
  	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"/>

	<!-- jQuery library -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

	<!-- Latest compiled JavaScript -->
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    
    <!--<link href="CSS/signin.css" rel="stylesheet"/>-->
    <link href="CSS/text.css" rel="stylesheet"/>
	
	<script src='https://cdn.tinymce.com/4/tinymce.min.js'></script>

	<script src="https://code.jquery.com/jquery-3.0.0.js" type="text/javascript"></script>
    
  
	<link rel="shortcut icon" href="image/lhamaFav.ico"/>
	<?php
		echo "<title>".$_SESSION['nomeMesa']."</title>"
    ?>
    <link rel="stylesheet" type="text/css" href="CSS/mesa.css"></link>
    <link rel="stylesheet" type="text/css" href="CSS/button.css"></link>
    <link rel="stylesheet" type="text/css" href="CSS/textarea.css"></link>
	<!--<link rel="stylesheet" type="text/css" href="CSS/page.css" />-->
	<link rel="stylesheet" type="text/css" href="CSS/chat.css" />
	
	<script>
		function autoRefresh_div()
		{
			$("#mensagens").load('mesa.xhtml' + ' #mensagens');// a function which will load data from other file after x seconds
			$(function() {
				var wtf    = $('#mensagens');
				var height = wtf[0].scrollHeight;
				wtf.scrollTop(height);
			}); 	
		}
		
		setInterval('autoRefresh_div()', 3000); // refresh div after 5 secs	
		
		$(function() {
				var wtf    = $('#mensagens');
				var height = wtf[0].scrollHeight;
				wtf.scrollTop(height);
			});
	</script>
	
	<script type="text/javascript">
	  tinymce.init({
		selector: '#editaFicha',
		theme: 'modern',
		width: 570,
		height: 300,
		plugins: [
		  'advlist autolink link image lists charmap hr',
		  'searchreplace wordcount media nonbreaking',
		  'save contextmenu directionality emoticons paste textcolor'
		],
		content_css: 'css/content.css',
		toolbar: 'insertfile undo redo | bold italic | link image | forecolor emoticons'
	  });
  </script>
    
  </head>

<body style="background-color:#211733;padding-top:40px;padding-left:5px;">       	
			<div class="col-md-2" id="lateral_esq">
				<h4 class="heading"><?php echo $_SESSION['nomeMesa']; ?></h4>
				<p style="color:#ffffff">ID: <?php echo $_SESSION['mesaID']; ?></p>
				<p style="color:#ffffff">Mestre: <?php echo $_SESSION['mestreNome']; ?></p>
				<div class="dropdown" >
					<button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">MESA<span class="caret"></span></button>
					<ul class="dropdown-menu" style="background-color:rgba(0,0,0,0)">
						<li><button type="button" data-toggle="modal" data-target="#myEditar" class="btn btn-default">Editar</button></li>
						<li><button type="button" data-toggle="modal" data-target="#myDeletar" class="btn btn-default">Deletar</button></li>
						<form method="POST" action="saiMesa.php">
							<li><button id="sair" name="sair" class="btn btn-default" type="submit">Sair</button></li>
						</form>
					</ul>
				</div>
				<!-- Modal -->
				<div id="myEditar" class="modal fade" role="dialog">
					<div class="modal-dialog">
						<!-- Modal content-->
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal">&times;</button>
								<h4 class="modal-title">Editar</h4>
							</div>
							<div class="modal-body">
								<form role="form" method="post" action="alteraMesa.php">
									<div id="edMesa">
										<form class="form-horizontal">
											<fieldset>
												<div class="form-group">
													<label class=" control-label" for="alteraMesa">Nome:</label>  
													<input id="alteraMesa" name="alteraMesa" placeholder="" class="form-control input-md" required="" type="text"/>
												</div>
												<div class="form-group">
													<label class=" control-label" for="novaSenha">Senha:</label>
													<input id="novaSenha" name="novaSenha" placeholder="" class="form-control input-md" required="" type="password"/>
												</div>
												<div class="form-group">
													<label class=" control-label" for="criar"></label>
													<button id="buscar" name="buscar" class="btn btn-default" type="submit">OK</button>
												</div>
											</fieldset>
										</form>
									</div>
								</form>
							</div>

						</div>
					</div>
				</div>
				
				<div id="myDeletar" class="modal fade" role="dialog">
					<div class="modal-dialog">
						<!-- Modal content-->
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal">&times;</button>
								<h4 class="modal-title">Deletar</h4>
							</div>
							<div class="modal-body">
								<form role="form" method="post" action="">
									<div id="deMesa">
										<form class="form-horizontal">
											<fieldset>
												<div class="form-group">
													<label class=" control-label" for="senhaRemMesa">Senha:</label>
													<input id="senhaRemMesa" name="senhaRemMesa" placeholder="" class="form-control input-md" required="" type="password"/>
												</div>
												<div class="form-group">
													<label class=" control-label" for="removeM"></label>
													<input id="removeM" name="removeM" class="btn btn-default" value="Confirmar" type="submit" >
												</div>
											</fieldset>
										</form>
									</div>
								</form>
									<?php
										if(isset($_POST['senhaRemMesa']))
										{
											$nomeMesa = $_POST['senhaRemMesa'];
											if($_SESSION['ID'] == $_SESSION['mestreID'])
											{
												$sql = "DELETE
														FROM mesa
														WHERE nomeMesa = '".$_SESSION['nomeMesa']."' ";
												$query = mysql_query($sql) or die (mysql_error());
												mesaClear();
												fichaDel();
												unset($_SESSION['nomeMesa']);
												unset($_SESSION['mestreID']);
												echo "<script language='javascript' type='text/javascript'>window.location.href='perfil.xhtml';</script>";
											}
											else
											{
												echo "Somente o Mestre tem permissÃ£o para deletar a mesa. Ponha-se no seu lugar =P";		
											}
										}
										
										function fichaDel()
										{
											$sqlFichaSel = "SELECT caminhoFicha
															FROM ficha
															WHERE mesaID = '".$_SESSION['mesaID']."' ";
											$queryFichaSel = mysql_query($sqlFichaSel) or die(mysql_error());
											$result = mysql_fetch_assoc($queryFichaSel);
											$caminhoFichaDel = $result['caminhoFicha'];
											unlink($caminhoFicha);
											$sqlFichaDel = "DELETE
															FROM ficha
															WHERE mesaID = '".$_SESSION['mesaID']."' ";
											$queryFichaDel = mysql_query($sqlFichaDel);
										}
										
										function mesaClear()
										{
											$sql = "UPDATE usuarios
													SET mesaID = 0
													WHERE mesaID = '".$_SESSION['mesaID']."' ";
											$query = mysql_query($sql) or die (mysql_error());	
										}
									?>
							</div>
						</div>
					</div>
				</div>
				
				<div class="dropdown" >
					<button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">FICHAS<span class="caret"></span></button>
					<ul class="dropdown-menu" style="background-color:rgba(0,0,0,0)">
						<?php
							$sql = "SELECT nome, caminhoFicha
							FROM ficha
							WHERE mesaID = '".$_SESSION['mesaID']."' ";
							$query = mysql_query($sql) or die (mysql_error());
							while($row = mysql_fetch_row($query))
							{
								$nome = $row[0];
								echo '<li><button type="button" data-toggle="modal" data-target="#editarFicha" class="btn btn-default">'.$nome.'</button></li>';
							}
						?>	
					</ul>
				</div>
				
				<div id="editarFicha" class="modal fade" role="dialog">
					<div class="modal-dialog">
						<!-- Modal content-->
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal">&times;</button>
								<h4 class="modal-title">Editar Ficha</h4>
							</div>
							<div class="modal-body">
								<form role="form" method="post" action="editaFicha.php">
									<div id="edMesa">
										<form class="form-horizontal">
											<textarea id="editaFicha" name="editaFicha">
												<?php
													$sql = "SELECT nome, caminhoFicha
															FROM ficha
															WHERE mesaID = '".$_SESSION['mesaID']."' AND nome = '".$nome."' ";
													$query = mysql_query($sql) or die (mysql_error());
													$result = mysql_fetch_assoc($query);
													$_SESSION['caminhoFicha'] = $result['caminhoFicha']; 
													$caminhoFicha = $result['caminhoFicha'];
													echo file_get_contents("$caminhoFicha");
												?>
											</textarea>
											<div class="form-group">
													<label class=" control-label" for="eFicha"></label>
													<input id="eFicha" name="eFicha" class="btn btn-default" value="Salvar" type="submit" >	
											</div>
										</form>
									</div>
								</form>
							</div>

						</div>
					</div>
				</div>
				
				
   				<br/>
   				<br/>
			 	<h4 class="heading">Criar Fichas</h4>
			 	<br/>
					<form method="POST" action="criaFicha.php">
						<input type="text" id="ficha" class="form-control" placeholder="Nome da ficha" name="nomeFicha" required=""/>
						<button class="btn btn-primary btn-block" type="submit">Criar</button>
					</form>
				
				</br>
					<form method="POST" action="removeFicha.php">
						<input type="text" id="ficha" class="form-control" placeholder="Nome da ficha" name="nomeFicha"/>
						<button class="btn btn-primary btn-block" type="submit">Deletar</button>
				</form>
				
				<!--<h4 class="heading">Fichas na Mesa</h4>
						<?php
							$sql = "SELECT nome, caminhoFicha
							FROM ficha
							WHERE mesaID = '".$_SESSION['mesaID']."' ";
							$query = mysql_query($sql) or die (mysql_error());
							while($row = mysql_fetch_row($query))
							{
								$nome = $row[0];
								echo "<p style='color:white'>".$nome."</p>";
							}
						?>-->
			 </div>
		 
		 
			<div class="col-md-7" id="chat">
					<div id="mensagens" >
						<div id="mInner">
							<?php 
								$sql = "SELECT mensagem, jogador, horario
								FROM chatMensagens
								WHERE mesaID = '".$_SESSION['mesaID']."'";
								$query = mysql_query($sql) or die(mysql_error()) ;
								while($row = mysql_fetch_row($query))
								{
									$sql2 = "SELECT nomeUsuario
										FROM usuarios
										WHERE ID = '".$row[1]."'";
									$query2 = mysql_query($sql2) or die(mysql_error()) ;
									$result = mysql_fetch_assoc($query2);
									$mensagem = $row[0];
									$timestamp = strtotime($row[2]);
									$horario = date('H:i', $timestamp);
									$jogador = $result['nomeUsuario'];
										echo "<div id='mJogador' style='color:black'>".$jogador.":  ".$mensagem."</div>";
										echo "<div id='mHorario' style='color:black'>".$horario."</div>";
								}
							?>
						</div>
					</div>
					
					<div id="caixa">
						<form method="POST" action="enviaMensagem.php">
							<textarea class="col-md-10" rows="1" cols="90" id="mensagem" name="mensagem"  style="width:683px; height:40px"> </textarea>
							<button id="send" name="send" class="btn col-md-2" value="Enviar" type="submit" style="width:80px; height:40px">Enviar</button>
						</form>
					</div>
						
				
					
			
			</div>
			
			<div id="divDados" class="col-md-1">
				<ul id="listaDados">
					<ul><button id="pngIcon" type="button" data-toggle="modal" data-target="#myMap"><img src="images/Map_Icon.png" alt="" style="widht:70px; height:70px"/></button></ul>
					<form method="POST" action="enviaMensagem.php">
							<ul><button id="pngIcon" type="submit" name="d4"><img src="images/d4.png" alt="" style="height:70px"/></button></ul>
							<ul><button id="pngIcon" type="submit" name="d6"><img src="images/d6.png" alt="" style="height:70px"/></button></ul>
							<ul><button id="pngIcon" type="submit" name="d8"><img src="images/d8.png" alt="" style="height:70px" /></button></ul>
							<ul><button id="pngIcon" type="submit" name="d10"><img src="images/d10.png" alt="" style="height:70px"/></button></ul>
							<ul><button id="pngIcon" type="submit" name="d12"><img src="images/d12.png" alt="" style="height:70px"/></button></ul>
							<ul><button id="pngIcon" type="submit" name="d20"><img src="images/d20_icon.png" alt="" style="height:70px"/></button></ul>
							<ul><button id="pngIcon" type="submit" name="d100"><img src="images/d_porcento.png" alt="" style="widht:75px; height:70px"/></button></ul>
					</form>
				</ul>
			</div>
			
			<div class="col-md-3" id="lateral_dir">
			<h4 class="heading">Jogadores</h4>
				<?php 
					$sql = "SELECT nomeUsuario
					FROM usuarios
					WHERE mesaID = '".$_SESSION['mesaID']."'";
				$query = mysql_query($sql) or die(mysql_error()) ;
				while($row = mysql_fetch_row($query))
				{
					$nome = $row[0];
					echo "<p style='color:white'>".$nome."</p>";
				}
				?>
			</div>
		
		
		<div id="myMap" class="modal fade" role="dialog">
			<div class="modal-dialog">
			<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Mapa</h4>
					</div>
					<div class="modal-body">
						<img src="images/mapa.png" style = "width: 550px"></img>
					</div>
				</div>
			</div>
		</div>		 


   		
		
  </body>
</html>
